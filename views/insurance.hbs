<div class="row my-3 p-10 bg-white border rounded">
    <div class="col-12 mb-4 d-flex justify-content-between align-items-center my-5">
        <div>
            <h3>Insurances</h3>
        </div>
        <div style="padding:10px 20px 10px 20px;" class="insurance_add_btn btn btn-light-primary btn-icon"><i
                class='fa fa-plus'></i></div>
    </div>
    <div class="col-12">
        <div class="table-responsive">
            <table class="table" id="insurance_tb">
                <thead>
                    <th>Insurance Logo</th>
                    <th>Insurance Name</th>
                    <th>Address</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Action</th>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="modal fade" id="insurance_modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <input type="hidden" id="modal_type" />
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title ">Insurance</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <h6>Insurance Name</h6>
                            <input id="insurance_modal_name" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <h6>Email</h6>
                            <input id="insurance_modal_email" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <h6>Phone</h6>
                            <input id="insurance_modal_phone" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <h6>Fax</h6>
                            <input id="insurance_modal_fax" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="form-group">
                            <h6>Address</h6>
                            <input id="insurance_modal_address" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <h6>City</h6>
                            <input id="insurance_modal_city" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <h6>State</h6>
                            <select id="insurance_modal_state" class="form-control custom-select">
                                <optgroup label="Alaskan/Hawaiian Time Zone">
                                    <option value="AK">Alaska</option>
                                    <option value="HI">Hawaii</option>
                                </optgroup>
                                <optgroup label="Pacific Time Zone">
                                    <option value="CA">California</option>
                                    <option value="NV">Nevada</option>
                                    <option value="OR">Oregon</option>
                                    <option value="WA">Washington</option>
                                </optgroup>
                                <optgroup label="Mountain Time Zone">
                                    <option value="AZ">Arizona</option>
                                    <option value="CO">Colorado</option>
                                    <option value="ID">Idaho</option>
                                    <option value="MT">Montana</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="UT">Utah</option>
                                    <option value="WY">Wyoming</option>
                                </optgroup>
                                <optgroup label="Central Time Zone">
                                    <option value="AL">Alabama</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IA">Iowa</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MO">Missouri</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TX">Texas</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="WI">Wisconsin</option>
                                </optgroup>
                                <optgroup label="Eastern Time Zone">
                                    <option value="CT">Connecticut</option>
                                    <option value="DE">Delaware</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="IN">Indiana</option>
                                    <option value="ME">Maine</option>
                                    <option value="MD">Maryland</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MI">Michigan</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NY" selected>New York</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="OH">Ohio</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="VT">Vermont</option>
                                    <option value="VA">Virginia</option>
                                    <option value="WV">West Virginia</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <h6>Zip</h6>
                            <input id="insurance_modal_zip" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <h6>Status</h6>
                            <select id="insurance_modal_status" class="form-control">
                                <option value="0">Inactive</option>
                                <option value="1">Active</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-light-primary insurance_modal_confirm"
                    data-dismiss="modal">Done</button>
                <button type="button" class="btn btn-light-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="insurance_image_modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title ">Insurance Logo</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="custom-file form-group">
                            <label class="custom-file-label" for="insurance_image">Select an Image</label>
                            <input type="file" id="insurance_image" accept="image/*" class="custom-file-input"
                                name="insurance-image" placeholder="Select an image" />
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-light-primary insurance_image_confirm"
                    data-dismiss="modal">Done</button>
                <button type="button" class="btn btn-light-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="insurance_clinic_modal">
    <div class="modal-dialog modal-md modal-dialog-scrollable">
        <input type="hidden" id="modal_insurance_id" />
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title ">Insurance Clinics</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                <div class="d-flex justify-content-start align-items-center px-5 mb-5 mx-1">
                    <input type="checkbox" style="width: 24px; height: 24px;" id="insurance_clinic_all" class="mx-1"
                        value="0" />
                    <label for="insurance_clinic_all" class="align-items-center m-0">
                        <h6 class="m-0">&nbsp;ALL</h6>
                    </label>
                </div>
                <div class="separator separator-solid mb-5"></div>
                <div class="row mx-1" id="insurance_clinic_list"></div>
            </div>
            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-light-primary insurance_clinic_modal_confirm"
                    data-dismiss="modal">Done</button>
                <button type="button" class="btn btn-light-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    var __item_count = 0
    var __selected_item_count = 0
    $(document).ready(() => {
        $.ajax({
            url: "{{env.HOST_URL}}{{env.PREFIX_URL}}/clinic/readOnlyNames",
            method: "POST",
            data: {},
            dataType: 'json',
            success: function (res) {
                let html = ""
                __item_count = res.data.length
                res.data.forEach(item => {
                    html += `<div class="col-md-12 d-flex justify-content-start align-items-center mx-5 mb-5">
                            <input class="insurance_clinic_items" type="checkbox" style="width: 24px; height: 24px;" id="insurance_clinic_item_${item.id}" class="mx-1"
                                value="${item.id}" />
                            <label for="insurance_clinic_${item.id}" class="align-items-center m-0">
                                <h6 class="m-0">&nbsp;${item.name}</h6>
                            </label>
                        </div>`
                })
                $("#insurance_clinic_list").html(html)
            }
        })

        let insurance_tb = $('#insurance_tb').DataTable({
            "pagingType": "full_numbers",
            "lengthMenu": [
                [10, 25, 50, -1],
                [10, 25, 50, "All"]
            ],
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search records",
            },
            "ajax": {
                "url": "{{env.HOST_URL}}{{env.PREFIX_URL}}/insurance/readInsurances",
                "type": "POST"
            },
            "columns": [
                {
                    data: 'img',
                    render: function (data, type, row) {
                        return `<img src="{{env.HOST_URL}}{{env.PREFIX_URL}}/assets/images/insurances/${row.img ? row.img : 'empty-img.jpg'}" width="100">`
                    }
                },
                { data: 'name' },
                { data: 'address' },
                { data: 'phone' },
                {
                    data: 'status',
                    render: function (data, type, row) {
                        return row.status == 1 ? '<span class="p-2 text-success bg-light-success rounded">Active</span>' : '<span class="p-2 text-danger bg-light-danger rounded">Inactive</span>'
                    }
                },
                {
                    data: 'id',
                    render: function (data, type, row) {
                        return `
                        <div idkey="`+ row.id + `">
                            <span class="btn btn-icon btn-sm btn-light-info insurance_clinic_btn"><i class="fa fa-hospital"></i></span>
                            <span class="btn btn-icon btn-sm btn-light-primary insurance_img_btn"><i class="fa fa-image"></i></span>
                            <span class="btn btn-icon btn-sm btn-light-warning insurance_edit_btn"><i class="fas fa-edit"></i></span>
                            <span class="btn btn-icon btn-sm btn-light-danger  insurance_delete_btn"><i class="fas fa-trash"></i></span>
                        </div>
                        `
                    }
                }
            ]
        });

        $(".insurance_add_btn").click(function () {
            $("#modal_type").val("0");

            $("#insurance_modal_name").val("");
            $("#insurance_modal_email").val("");
            $("#insurance_modal_phone").val("");
            $("#insurance_modal_fax").val("");
            $("#insurance_modal_address").val("");
            $("#insurance_modal_city").val("");
            $("#insurance_modal_state").val("NY");
            $("#insurance_modal_zip").val("");
            $("#insurance_modal_status").val("1");

            $("#insurance_modal").modal('show');
        });

        $(document).on("click", ".insurance_edit_btn", function () {
            $("#modal_type").val("1");
            window.id = $(this).parent().attr("idkey");
            $.ajax({
                url: '{{env.HOST_URL}}{{env.PREFIX_URL}}/insurance/readOneInsurance',
                method: "POST",
                data: { id: window.id },
                dataType: "json",
                success: function (data) {
                    $("#insurance_modal_name").val(data['name']);
                    $("#insurance_modal_email").val(data['email']);
                    $("#insurance_modal_phone").val(data['phone']);
                    $("#insurance_modal_fax").val(data['fax']);
                    $("#insurance_modal_address").val(data['address']);
                    $("#insurance_modal_city").val(data['city']);
                    $("#insurance_modal_state").val(data['state']);
                    $("#insurance_modal_zip").val(data['zip']);
                    $("#insurance_modal_status").val(data['status']);

                    $("#insurance_modal").modal('show');
                }
            });
        });

        $(document).on("click", ".insurance_img_btn", function () {
            window.id = $(this).parent().attr("idkey");

            $("#insurance_image_modal").modal("show")
        })

        $(".insurance_modal_confirm").click(function () {
            $.ajax({
                url: `{{env.HOST_URL}}{{env.PREFIX_URL}}/insurance/${$("#modal_type").val() == "0" ? 'createInsurance' : 'updateInsurance'}`,
                method: "POST",
                data: {
                    id: window.id,
                    name: $("#insurance_modal_name").val(),
                    email: $("#insurance_modal_email").val(),
                    phone: $("#insurance_modal_phone").val(),
                    fax: $("#insurance_modal_fax").val(),
                    address: $("#insurance_modal_address").val(),
                    city: $("#insurance_modal_city").val(),
                    state: $("#insurance_modal_state").val(),
                    zip: $("#insurance_modal_zip").val(),
                    status: $("#insurance_modal_status").val()
                },
                dataType: "text",
                success: function (data) {
                    handleTableResponse(data, '#insurance_tb', $("#modal_type").val() == 0 ? 'Add' : 'Update');
                }
            });
        });

        $(".insurance_image_confirm").click(function () {
            var formData = new FormData();
            var fileInput = document.getElementById('insurance_image');
            var file = fileInput.files[0];
            var id = window.id;
            formData.append('file', file);
            formData.append('id', id);
            $.ajax({
                url: '{{env.HOST_URL}}{{env.PREFIX_URL}}/insurance/uploadInsuranceImage',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (data) {
                    handleTableResponse(data, '#insurance_tb', 'Upload');
                }
            });
        })

        $(document).on("click", ".insurance_clinic_btn", function () {
            $("#modal_insurance_id").val($(this).parent().attr("idkey"))
            $.ajax({
                url: "{{env.HOST_URL}}{{env.PREFIX_URL}}/clinic_insurance/readClinicOfInsurance",
                method: "POST",
                data: { insurance_id: $(this).parent().attr("idkey") },
                dataType: 'json',
                success: function (res) {
                    $("#insurance_clinic_all").prop("checked", false)
                    $(".insurance_clinic_items").prop("checked", false)
                    __selected_item_count = res.length
                    res.forEach(item => {
                        $(`#insurance_clinic_item_${item.clinic_id}`).prop('checked', true)
                    })

                    if (__selected_item_count == __item_count) {
                        $("#insurance_clinic_all").prop("checked", true)
                    } else {
                        $("#insurance_clinic_all").prop("checked", false)
                    }

                    $("#insurance_clinic_modal").modal("show")
                }
            })
        })

        $(document).on("click", ".insurance_delete_btn", function () {
            window.id = $(this).parent().attr("idkey");
            var tmp = $(this).parent().parent().parent();
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.value) {
                    $.ajax({
                        url: '{{env.HOST_URL}}{{env.PREFIX_URL}}/insurance/deleteInsurance',
                        method: "POST",
                        data: { id: window.id },
                        dataType: "text",
                        success: function (data) {
                            if (data = "ok")
                                tmp.remove();
                        }
                    });
                }
            });
        });

        $("#insurance_clinic_all").click(function () {
            if ($(this).prop('checked') == true) {
                $(".insurance_clinic_items").prop('checked', true)
            } else {
                $(".insurance_clinic_items").prop('checked', false)
            }
            $.ajax({
                url: `{{env.HOST_URL}}{{env.PREFIX_URL}}/clinic_insurance/${$(this).prop("checked") == true ? "createByInsurance" : "deleteByInsurance"}`,
                method: "POST",
                data: { insurance_id: $("#modal_insurance_id").val() },
                dataType: 'text',
                success: function (res) {
                    if (res == "ok") {
                        toastr.success("Success!")
                    } else {
                        toastr.error("Failed!")
                    }
                },
                error: function (error) {
                    toastr.error("Error!")
                }
            })
        })

        $(document).on("click", ".insurance_clinic_items", function () {
            $.ajax({
                url: `{{env.HOST_URL}}{{env.PREFIX_URL}}/clinic_insurance/${$(this).prop("checked") == true ? "createClinicInsurance" : "deleteByInsuranceAndClinic"}`,
                method: "POST",
                data: { insurance_id: $("#modal_insurance_id").val(), clinic_id: $(this).val() },
                dataType: 'text',
                success: function (res) {
                    if (res == "ok") {
                        toastr.success("Success!")
                    } else {
                        toastr.error("Failed!")
                    }
                },
                error: function (error) {
                    toastr.error("Error!")
                }
            })

            $(this).prop("checked") == true ? __selected_item_count++ : __selected_item_count--;

            if (__selected_item_count == __item_count) {
                $("#insurance_clinic_all").prop("checked", true)
            } else {
                $("#insurance_clinic_all").prop("checked", false)
            }
        })
    });
</script>